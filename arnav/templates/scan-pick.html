{% extends 'base.html' %}
{% load static %}

{% block content %}

<nav class="mobile-nav">
    <div class="nav-content1">
        <div style="margin: 10px;">
            <a href="{% url 'index' %}" style="text-decoration: none; "><i class="arrow right"></i>
            </a>
        </div>   
        <div >
 
        </div>
    </div>
</nav>
<div class="error-message">
    Please use mobile to continue.
</div>
<div style="text-align: center;" class="formcontainer mobile-dissapear">
<h2>Scan item to be pick QR code to start</h2>

</div>
<div class="formcontainer1 mobile-dissapear">
<video id='video' autoplay playsinline></video>
<canvas id="canvas" style='display:none;' width="400px" height="500px"></canvas>
</div>
{% comment %} <ul id="scanned_urls_list">
    {% for url in scanned_urls %}
        <li><a href="{{ url }}">{{ url }}</a></li>
    {% endfor %}
</ul> {% endcomment %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      var video = document.getElementById('video');
      var img = document.getElementById("client");
      var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
      var mode = true;
      
      video.width = 300;
      video.height = 200;
  
      // Scale the graph canvas accordingly to the window size
      var widthupdate = window.innerWidth*0.3;
      var heightupdate = window.innerHeight*0.4;
  
      function Mode(){
          if (mode == true){
              mode = false;
              var ws = new WebSocket(
                  ws_scheme + '://' + window.location.host + '/'
              );
              ws.onopen = (event) => {
                  console.log('websocket connected!!!');
              };
              ws.onmessage = (event) => {
              const url = event.data;
              console.log('Received URL:', url);
              window.location.href = url;
              
              };
              ws.onclose = (event) => {
                  console.log('Close');
              };
              if (navigator.mediaDevices.getUserMedia) {
              console.log("TRY")
              navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment'} })
              .then(function(stream) {
              video.srcObject = stream;
              video.setAttribute('autoplay', true);
              video.play();
              var width = video.width;
              var height = video.height;
              var delay = 200; // adjust the delay to fit your needs (ms)
              var jpegQuality = 0.5; // adjust the quality to fit your needs (0.0 -> 1.0)
  
              setInterval(function() {
              context.drawImage(video, 0, 0, width, height);
              console.log("IMAGE MADE")
              canvas.toBlob(function(blob) {
                  if (ws.readyState == WebSocket.OPEN) {
                      if (mode == true){
                          ws.send(new Uint8Array([]));
                      } else {
                          ws.send(blob);
                      }
                  }
              }, 'image/jpeg', jpegQuality);
              }, delay);
              });}
          }
          else if (mode == false){
              mode = true;
              video.pause();
              video.srcObject.getVideoTracks()[0].stop();
              video.srcObject = null;
              setTimeout(function() {
                  clearInterval(createchart);
              },500);
          }
      };

      Mode()
      
      </script>

{% endblock content %}